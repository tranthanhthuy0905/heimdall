service {
  name = "heimdall"
  environment {
    type = ${?HEIMDALL_ENV}
  }
  properties = {}
  cache {
    username {
      redis-ttl = 1 hours
      mem-ttl = 20 minutes
    }
    domain {
      redis-ttl = 5 hours
      mem-ttl = 1 hours
    }
    # We have a fix in the latern service to extends the presigned url to 2 hours. However, @dkong reported the issue still
    # The issue happens when the presigned URL that is used to serve the evidence file to RTM is expired.
    # happening and we found the root cause of this issue relates to the mio.range-cacher.
    # The mio.RangeCacher extract the file as the cache key => multiple presigned URLs of same evidence file will have same
    # cache key. In the other hand, the cacher assumes the newer URL will have longer expiration than the older one, So it
    # always uses the newer URL for a cache key.
    # The logic above causes the problem when the Presigned URL which was generated from the Heimdall (when the user views
    # the evidence on EDP) has shorter expiration (60s) than the presigned URL which was generated by Lantern (7200s).
    # EVP-587 2hrs expiration. https:#git.taservs.net/ecom/lantern/pull/2064/files
    url {
      expired = 2 hours
      redis-ttl = 1 hours
      mem-ttl = 20 minutes
    }
  }
  route_splitter {
    enabled = false
  }
}

play {
  http {
    secret.key = ${?HEIMDALL_PLAYHTTP_SECRET}
    forwarded.trustedProxies=["0.0.0.0/0", "::/0"]
  }
  i18n {
    langs = ["de", "en", "en-US", "pt-BR", "es", "sv", "fr", "en-GB"]
  }
  modules {
    enabled += "Module"
  }
}

# Filter configuration
include "./filters.conf"

# EDC and Zookeeper
edc {
  zookeeper {
    connection_string = ${?ZOOKEEPER_HOSTS}
    hosts = ${?ZOOKEEPER_HOSTS}
  }

  cache {
    namespace = "heimdall"
    version = "v1"
    enable_cache: true
    redis {
      hosts = [${?HEIMDALL_REDIS_HOSTS_1}, ${?HEIMDALL_REDIS_HOSTS_2}]
      port = ${?HEIMDALL_REDIS_PORT}
      password = ${?HEIMDALL_REDIS_PASSWORD}
    }
  }
  queue {
    enable_probe_notifier = true
    probe_video {
      username = ""
      password = ""
      url = ""
      type = "activemq"
      destination_type = "topic"
      name = "dev-video-probed-topic"
      wait_time_seconds = -1
      visibility_timeout_seconds = -1
      time_to_live_ms = 86400000
      max_deliveries = 3
      use_exponential_backoff = true
      initial_redelivery_delay_ms = 5000
      redelivery_delay_ms = 1000
      back_off_multiplier = 5
      max_redelivery_delay = -1
      prefetch = 1
      non_blocking_redelivery = true
    }
  }
}

# Thrift APIS and Secrets
edc.service {
  dredd {
    thrift_auth_type = "internal"
    thrift_auth_secret = ${?SECRET_dredd}
  }

  sessions {
    thrift_auth_type = "internal"
    thrift_auth_secret = ${?SECRET_sessions}
  }

  audit {
    thrift_auth_type = "internal"
    thrift_auth_secret = ${?SECRET_audit}
  }

  komrade {
    thrift_auth_type = "internal"
    thrift_auth_secret = ${?SECRET_komrade}
  }

  pdp {
    enabled = false
    host = ${?SERVICE_PDP_HOST}
    port = ${?SERVICE_PDP_PORT}
    secret = ${?SECRET_pdp}
    ssl = true
  }
}

heimdall.api_prefix = "/api/v1"
